<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo - Professional Voice Messenger</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Color Palette */
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --accent: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #f94144;
            
            /* Neutral Colors */
            --dark-bg: #121826;
            --dark-card: #1e293b;
            --dark-border: #334155;
            --dark-text: #f8fafc;
            --dark-text-secondary: #cbd5e1;
            
            --light-bg: #f8fafc;
            --light-card: #ffffff;
            --light-border: #e2e8f0;
            --light-text: #1e293b;
            --light-text-secondary: #64748b;
            
            /* Typography */
            --font-main: 'Inter', sans-serif;
            
            /* Spacing */
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.25);
            
            /* Transitions */
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: color var(--transition-fast), background-color var(--transition-fast), border-color var(--transition-fast);
        }

        html, body {
            height: 100%;
            font-family: var(--font-main);
            font-size: 16px;
            line-height: 1.6;
        }

        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a2238 100%);
            color: var(--dark-text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body.light-mode {
            background: linear-gradient(135deg, var(--light-bg) 0%, #e2e8f0 100%);
            color: var(--light-text);
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: var(--space-sm);
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            font-size: 2rem;
        }

        h3 {
            font-size: 1.5rem;
        }

        p {
            margin-bottom: var(--space-sm);
            color: var(--dark-text-secondary);
        }

        body.light-mode p {
            color: var(--light-text-secondary);
        }

        a {
            color: var(--primary);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--primary-dark);
        }

        /* Layout */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-md);
        }

        .app {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--space-lg) 0;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md) 0;
            margin-bottom: var(--space-lg);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .logo-icon {
            font-size: 2rem;
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: var(--space-sm);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-main);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all var(--transition-normal);
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--dark-text);
            border: 1px solid var(--dark-border);
        }

        body.light-mode .btn-secondary {
            background: rgba(0, 0, 0, 0.05);
            color: var(--light-text);
            border: 1px solid var(--light-border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        body.light-mode .btn-secondary:hover:not(:disabled) {
            background: rgba(0, 0, 0, 0.08);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #e03131;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: #000;
        }

        .btn-success:hover:not(:disabled) {
            background: #3aa8d0;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning);
            color: #000;
        }

        .btn-warning:hover:not(:disabled) {
            background: #e0861b;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-icon {
            padding: 0.75rem;
            width: 3rem;
            height: 3rem;
        }

        /* Cards */
        .card {
            background: var(--dark-card);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--dark-border);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }

        body.light-mode .card {
            background: var(--light-card);
            border: 1px solid var(--light-border);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-text);
        }

        body.light-mode .card-title {
            color: var(--light-text);
        }

        /* Forms */
        .form-group {
            margin-bottom: var(--space-md);
        }

        label {
            display: block;
            margin-bottom: var(--space-xs);
            font-weight: 500;
            color: var(--dark-text);
        }

        body.light-mode label {
            color: var(--light-text);
        }

        .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.05);
            color: var(--dark-text);
            font-family: var(--font-main);
            font-size: 1rem;
            transition: all var(--transition-fast);
        }

        body.light-mode .form-control {
            background: white;
            border: 1px solid var(--light-border);
            color: var(--light-text);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1rem;
            padding-right: 3rem;
        }

        /* Recording Section */
        .recording-section {
            text-align: center;
            padding: var(--space-lg) 0;
        }

        .mic-container {
            position: relative;
            display: inline-block;
            margin-bottom: var(--space-md);
        }

        .mic-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-size: 2.5rem;
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .mic-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: var(--shadow-xl);
        }

        .mic-btn.recording {
            background: linear-gradient(135deg, var(--danger) 0%, #c1121f 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(244, 67, 54, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
            }
        }

        .recording-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            background: var(--danger);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .recording-timer {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: var(--space-sm);
            color: var(--dark-text);
        }

        body.light-mode .recording-timer {
            color: var(--light-text);
        }

        /* Audio Player */
        .audio-player {
            width: 100%;
            margin: var(--space-md) 0;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.05);
            padding: var(--space-md);
        }

        body.light-mode .audio-player {
            background: rgba(0, 0, 0, 0.03);
        }

        .audio-player audio {
            width: 100%;
            border-radius: var(--radius-sm);
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--space-md);
            margin-top: var(--space-md);
        }

        /* Voice Message Card */
        .voice-card {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .voice-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-sm);
        }

        .voice-card-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--dark-text);
        }

        body.light-mode .voice-card-title {
            color: var(--light-text);
        }

        .voice-card-meta {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-bottom: var(--space-sm);
        }

        .voice-card-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--dark-text-secondary);
        }

        body.light-mode .voice-card-meta-item {
            color: var(--light-text-secondary);
        }

        .voice-card-actions {
            display: flex;
            gap: var(--space-xs);
            margin-top: auto;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active {
            background: rgba(76, 201, 240, 0.2);
            color: var(--success);
        }

        .status-expired {
            background: rgba(249, 65, 68, 0.2);
            color: var(--danger);
        }

        .status-pending {
            background: rgba(248, 150, 30, 0.2);
            color: var(--warning);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--dark-border);
            margin-bottom: var(--space-lg);
        }

        body.light-mode .tabs {
            border-bottom: 1px solid var(--light-border);
        }

        .tab {
            padding: var(--space-sm) var(--space-md);
            cursor: pointer;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all var(--transition-fast);
            color: var(--dark-text-secondary);
        }

        body.light-mode .tab {
            color: var(--light-text-secondary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .stat-card {
            text-align: center;
            padding: var(--space-md);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: var(--space-xs);
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--dark-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        body.light-mode .stat-label {
            color: var(--light-text-secondary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--dark-text-secondary);
        }

        body.light-mode .empty-state {
            color: var(--light-text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--space-md);
            opacity: 0.5;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--dark-card);
            color: var(--dark-text);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--primary);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            max-width: 400px;
            transform: translateX(120%);
            transition: transform var(--transition-normal);
        }

        body.light-mode .notification {
            background: var(--light-card);
            color: var(--light-text);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            font-size: 1.5rem;
        }

        .notification-success {
            border-left-color: var(--success);
        }

        .notification-error {
            border-left-color: var(--danger);
        }

        .notification-warning {
            border-left-color: var(--warning);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: var(--space-lg) 0;
            margin-top: var(--space-xl);
            border-top: 1px solid var(--dark-border);
            color: var(--dark-text-secondary);
        }

        body.light-mode .footer {
            border-top: 1px solid var(--light-border);
            color: var(--light-text-secondary);
        }

        /* Receiver View */
        .receiver-view {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .receiver-icon {
            font-size: 4rem;
            margin-bottom: var(--space-md);
            color: var(--primary);
        }

        .sender-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin: var(--space-md) 0;
        }

        body.light-mode .sender-info {
            background: rgba(0, 0, 0, 0.03);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            h2 {
                font-size: 1.75rem;
            }
            
            .header {
                flex-direction: column;
                gap: var(--space-md);
                text-align: center;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .mic-btn {
                width: 100px;
                height: 100px;
                font-size: 2rem;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .voice-card-actions {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 var(--space-sm);
            }
            
            .card {
                padding: var(--space-md);
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 { margin-top: var(--space-xs); }
        .mt-2 { margin-top: var(--space-sm); }
        .mt-3 { margin-top: var(--space-md); }
        .mt-4 { margin-top: var(--space-lg); }
        .mt-5 { margin-top: var(--space-xl); }

        .mb-1 { margin-bottom: var(--space-xs); }
        .mb-2 { margin-bottom: var(--space-sm); }
        .mb-3 { margin-bottom: var(--space-md); }
        .mb-4 { margin-bottom: var(--space-lg); }
        .mb-5 { margin-bottom: var(--space-xl); }

        .flex {
            display: flex;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flex-between {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .flex-column {
            flex-direction: column;
        }

        .gap-1 { gap: var(--space-xs); }
        .gap-2 { gap: var(--space-sm); }
        .gap-3 { gap: var(--space-md); }
        .gap-4 { gap: var(--space-lg); }
        .gap-5 { gap: var(--space-xl); }
    </style>
</head>
<body>
    <!-- Notification System -->
    <div id="notification" class="notification">
        <div class="notification-icon"></div>
        <div class="notification-content"></div>
    </div>

    <div class="container">
        <div class="app">
            <!-- Header -->
            <header class="header">
                <div class="logo">
                    <i class="fas fa-wave-square logo-icon"></i>
                    <h1>Echo Voice</h1>
                </div>
                <div class="header-actions">
                    <button id="themeToggle" class="btn btn-secondary">
                        <i class="fas fa-moon"></i>
                        <span>Dark Mode</span>
                    </button>
                    <button id="guideBtn" class="btn btn-secondary">
                        <i class="fas fa-question-circle"></i>
                        <span>Guide</span>
                    </button>
                </div>
            </header>

            <!-- Sender View (Default) -->
            <div id="senderView">
                <!-- Stats Section -->
                <section class="stats-container">
                    <div class="card stat-card">
                        <div class="stat-value" id="totalMessages">0</div>
                        <div class="stat-label">Voice Messages</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-value" id="totalPlays">0</div>
                        <div class="stat-label">Total Plays</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-value" id="pendingRequests">0</div>
                        <div class="stat-label">Pending Requests</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-value" id="successRate">0%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </section>

                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" data-tab="record">Record New</div>
                    <div class="tab" data-tab="messages">My Messages</div>
                    <div class="tab" data-tab="requests">Pending Requests</div>
                </div>

                <!-- Record Tab -->
                <div id="record-tab" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Record Voice Message</h2>
                        </div>
                        
                        <div class="form-group">
                            <label for="senderName">Your Name</label>
                            <input type="text" id="senderName" class="form-control" placeholder="Enter your name or stay anonymous">
                        </div>
                        
                        <div class="form-group">
                            <label for="privacy">Privacy Setting</label>
                            <select id="privacy" class="form-control">
                                <option value="anonymous">Anonymous - Hide identity</option>
                                <option value="reveal_on_request">Reveal on Request - Approve identity requests</option>
                                <option value="auto_reveal">Auto Reveal - Show identity automatically</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="expiry">Message Expiry</label>
                            <select id="expiry" class="form-control">
                                <option value="permanent">Permanent - Never expires</option>
                                <option value="24h">24 hours - Auto-deletes after 1 day</option>
                                <option value="1h">1 hour - Quick temporary message</option>
                            </select>
                        </div>
                        
                        <div class="recording-section">
                            <div class="mic-container">
                                <button id="micBtn" class="mic-btn">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <div id="recordingIndicator" class="recording-indicator hidden">
                                    <i class="fas fa-circle"></i>
                                </div>
                            </div>
                            
                            <div id="recordingTimer" class="recording-timer hidden">00:00</div>
                            
                            <div class="flex-center gap-2 mt-3">
                                <button id="stopBtn" class="btn btn-danger" disabled>
                                    <i class="fas fa-stop"></i>
                                    Stop Recording
                                </button>
                                <button id="uploadBtn" class="btn btn-success hidden">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    Upload Voice
                                </button>
                            </div>
                        </div>
                        
                        <div id="audioPreviewSection" class="hidden mt-4">
                            <h3>Preview Recording</h3>
                            <div class="audio-player">
                                <audio id="preview" controls></audio>
                            </div>
                            <div class="flex-center gap-2 mt-2">
                                <button id="reRecordBtn" class="btn btn-warning">
                                    <i class="fas fa-redo"></i>
                                    Re-record
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages Tab -->
                <div id="messages-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">My Voice Messages</h2>
                            <div class="flex gap-2">
                                <button class="btn btn-secondary btn-sm" id="clearAllBtn">
                                    <i class="fas fa-trash"></i>
                                    Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid" id="voiceMessagesGrid">
                            <!-- Voice message cards will be dynamically inserted here -->
                            <div class="empty-state" id="emptyMessages">
                                <div class="empty-state-icon">
                                    <i class="fas fa-microphone-slash"></i>
                                </div>
                                <h3>No Voice Messages Yet</h3>
                                <p>Record your first voice message to get started!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Requests Tab -->
                <div id="requests-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Pending Identity Requests</h2>
                        </div>
                        
                        <div class="grid" id="requestsGrid">
                            <!-- Request cards will be dynamically inserted here -->
                            <div class="empty-state" id="emptyRequests">
                                <div class="empty-state-icon">
                                    <i class="fas fa-user-clock"></i>
                                </div>
                                <h3>No Pending Requests</h3>
                                <p>When someone requests to know your identity, it will appear here.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receiver View -->
            <div id="receiverView" class="hidden">
                <div class="receiver-view">
                    <div class="card">
                        <div class="receiver-icon">
                            <i class="fas fa-message"></i>
                        </div>
                        <h2>Voice Message for You</h2>
                        <p>You've received a voice message. Click play to listen.</p>
                        
                        <div id="receiverMessageInfo" class="sender-info hidden">
                            <h4>Message Information</h4>
                            <div id="messageDetails"></div>
                        </div>
                        
                        <div class="audio-player mt-4">
                            <audio id="receiverAudio" controls></audio>
                        </div>
                        
                        <div class="flex-center gap-2 mt-4">
                            <button id="playBtn" class="btn btn-primary">
                                <i class="fas fa-play"></i>
                                Play Message
                            </button>
                            <button id="downloadBtn" class="btn btn-secondary">
                                <i class="fas fa-download"></i>
                                Download
                            </button>
                        </div>
                        
                        <div id="identityRequestSection" class="mt-4 hidden">
                            <div class="card">
                                <h4>Identity Request</h4>
                                <p>This sender has chosen to remain anonymous. Would you like to request their identity?</p>
                                <button id="requestIdentityBtn" class="btn btn-warning">
                                    <i class="fas fa-user-secret"></i>
                                    Request Identity
                                </button>
                            </div>
                        </div>
                        
                        <div id="identityRevealed" class="mt-4 hidden">
                            <div class="card">
                                <h4>Sender Identity</h4>
                                <div id="senderIdentity"></div>
                            </div>
                        </div>
                        
                        <div id="errorMessage" class="mt-4 hidden">
                            <div class="card" style="border-left-color: var(--danger);">
                                <h4 style="color: var(--danger);">Message Not Found</h4>
                                <p>The voice message you're looking for doesn't exist or has expired.</p>
                                <button id="backToHome" class="btn btn-primary mt-2">
                                    <i class="fas fa-home"></i>
                                    Back to Home
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2023 Echo Voice Messenger. All rights reserved.</p>
            <p class="mt-1">Secure, private voice messaging for professionals.</p>
        </div>
    </footer>

    <script>
        // Data Management System
        class VoiceMessageManager {
            constructor() {
                this.messages = JSON.parse(localStorage.getItem('echoMessages')) || [];
                this.requests = JSON.parse(localStorage.getItem('echoRequests')) || [];
                this.stats = JSON.parse(localStorage.getItem('echoStats')) || {
                    totalMessages: 0,
                    totalPlays: 0,
                    pendingRequests: 0,
                    successRate: 0
                };
            }

            saveMessages() {
                localStorage.setItem('echoMessages', JSON.stringify(this.messages));
                this.updateStats();
            }

            saveRequests() {
                localStorage.setItem('echoRequests', JSON.stringify(this.requests));
                this.updateStats();
            }

            saveStats() {
                localStorage.setItem('echoStats', JSON.stringify(this.stats));
            }

            addMessage(message) {
                const newMessage = {
                    id: 'msg_' + Date.now(),
                    title: message.title || 'Voice Message',
                    senderName: message.senderName || 'Anonymous',
                    privacy: message.privacy || 'anonymous',
                    expiry: message.expiry || 'permanent',
                    timestamp: new Date().toISOString(),
                    playCount: 0,
                    audioUrl: message.audioUrl,
                    audioBlob: message.audioBlob,
                    status: 'active'
                };
                
                this.messages.unshift(newMessage);
                this.saveMessages();
                return newMessage;
            }

            getMessage(messageId) {
                return this.messages.find(msg => msg.id === messageId);
            }

            deleteMessage(messageId) {
                this.messages = this.messages.filter(msg => msg.id !== messageId);
                this.saveMessages();
            }

            clearAllMessages() {
                this.messages = [];
                this.saveMessages();
            }

            addRequest(messageId, requesterInfo) {
                const message = this.messages.find(msg => msg.id === messageId);
                if (!message) return null;

                const newRequest = {
                    id: 'req_' + Date.now(),
                    messageId: messageId,
                    messageTitle: message.title,
                    requesterInfo: requesterInfo,
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                };

                this.requests.unshift(newRequest);
                this.saveRequests();
                return newRequest;
            }

            resolveRequest(requestId, approved = false) {
                const request = this.requests.find(req => req.id === requestId);
                if (!request) return;

                if (approved) {
                    request.status = 'approved';
                    // Update the message to show sender identity
                    const message = this.messages.find(msg => msg.id === request.messageId);
                    if (message) {
                        message.revealApproved = true;
                        this.saveMessages();
                    }
                } else {
                    request.status = 'denied';
                }

                this.saveRequests();
            }

            updateStats() {
                this.stats.totalMessages = this.messages.length;
                this.stats.pendingRequests = this.requests.filter(req => req.status === 'pending').length;
                this.stats.totalPlays = this.messages.reduce((total, msg) => total + (msg.playCount || 0), 0);
                
                const activeMessages = this.messages.filter(msg => msg.status === 'active').length;
                this.stats.successRate = this.messages.length > 0 ? 
                    Math.round((activeMessages / this.messages.length) * 100) : 0;
                
                this.saveStats();
            }

            getMessages() {
                return this.messages;
            }

            getRequests() {
                return this.requests.filter(req => req.status === 'pending');
            }

            getStats() {
                return this.stats;
            }
        }

        // DOM Elements
        const themeToggle = document.getElementById('themeToggle');
        const guideBtn = document.getElementById('guideBtn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const micBtn = document.getElementById('micBtn');
        const stopBtn = document.getElementById('stopBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const reRecordBtn = document.getElementById('reRecordBtn');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const recordingTimer = document.getElementById('recordingTimer');
        const audioPreviewSection = document.getElementById('audioPreviewSection');
        const preview = document.getElementById('preview');
        const notification = document.getElementById('notification');
        const notificationIcon = notification.querySelector('.notification-icon');
        const notificationContent = notification.querySelector('.notification-content');
        const voiceMessagesGrid = document.getElementById('voiceMessagesGrid');
        const requestsGrid = document.getElementById('requestsGrid');
        const emptyMessages = document.getElementById('emptyMessages');
        const emptyRequests = document.getElementById('emptyRequests');
        const clearAllBtn = document.getElementById('clearAllBtn');

        // Stats Elements
        const totalMessagesEl = document.getElementById('totalMessages');
        const totalPlaysEl = document.getElementById('totalPlays');
        const pendingRequestsEl = document.getElementById('pendingRequests');
        const successRateEl = document.getElementById('successRate');

        // Receiver Elements
        const senderView = document.getElementById('senderView');
        const receiverView = document.getElementById('receiverView');
        const receiverAudio = document.getElementById('receiverAudio');
        const playBtn = document.getElementById('playBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const requestIdentityBtn = document.getElementById('requestIdentityBtn');
        const identityRequestSection = document.getElementById('identityRequestSection');
        const identityRevealed = document.getElementById('identityRevealed');
        const senderIdentity = document.getElementById('senderIdentity');
        const errorMessage = document.getElementById('errorMessage');
        const backToHome = document.getElementById('backToHome');
        const receiverMessageInfo = document.getElementById('receiverMessageInfo');
        const messageDetails = document.getElementById('messageDetails');

        // Initialize Data Manager
        const voiceManager = new VoiceMessageManager();

        // App State
        let isRecording = false;
        let recordingStartTime;
        let timerInterval;
        let mediaRecorder;
        let audioChunks = [];
        let currentAudioBlob = null;
        let currentMessageId = null;

        // Check URL parameters on load
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const voiceId = urlParams.get('voice');
            
            if (voiceId) {
                // Show receiver view
                showReceiverView(voiceId);
            } else {
                // Show sender view
                showSenderView();
            }
        }

        // Show Sender View
        function showSenderView() {
            senderView.style.display = 'block';
            receiverView.style.display = 'none';
            initApp();
        }

        // Show Receiver View
        function showReceiverView(voiceId) {
            senderView.style.display = 'none';
            receiverView.style.display = 'block';
            
            const message = voiceManager.getMessage(voiceId);
            
            if (!message) {
                // Message not found
                showReceiverError();
                return;
            }
            
            // Load message for receiver
            loadReceiverMessage(message);
        }

        // Load message for receiver
        function loadReceiverMessage(message) {
            // Update play count
            message.playCount = (message.playCount || 0) + 1;
            voiceManager.saveMessages();
            
            // Set audio source
            if (message.audioUrl) {
                receiverAudio.src = message.audioUrl;
            }
            
            // Show message info
            receiverMessageInfo.classList.remove('hidden');
            messageDetails.innerHTML = `
                <p><strong>Sender:</strong> ${message.privacy === 'anonymous' ? 'Anonymous' : message.senderName}</p>
                <p><strong>Date:</strong> ${new Date(message.timestamp).toLocaleDateString()}</p>
                <p><strong>Plays:</strong> ${message.playCount}</p>
            `;
            
            // Handle privacy settings
            if (message.privacy === 'reveal_on_request') {
                if (message.revealApproved) {
                    // Identity already approved
                    identityRevealed.classList.remove('hidden');
                    senderIdentity.innerHTML = `<p><strong>Sender:</strong> ${message.senderName}</p>`;
                } else {
                    // Show identity request option
                    identityRequestSection.classList.remove('hidden');
                }
            } else if (message.privacy === 'auto_reveal') {
                // Show identity automatically
                identityRevealed.classList.remove('hidden');
                senderIdentity.innerHTML = `<p><strong>Sender:</strong> ${message.senderName}</p>`;
            }
            
            // Store current message ID for identity requests
            currentMessageId = message.id;
        }

        // Show receiver error
        function showReceiverError() {
            errorMessage.classList.remove('hidden');
        }

        // Initialize App
        function initApp() {
            updateStatsDisplay();
            renderMessages();
            renderRequests();
            
            // Show welcome notification
            setTimeout(() => {
                showNotification('info', 'Welcome to Echo Voice Messenger! Record and share voice messages securely.');
            }, 1000);
        }

        // Theme Toggle
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            const isLightMode = document.body.classList.contains('light-mode');
            themeToggle.innerHTML = isLightMode ? 
                '<i class="fas fa-sun"></i><span>Light Mode</span>' : 
                '<i class="fas fa-moon"></i><span>Dark Mode</span>';
        });

        // Guide Button
        guideBtn.addEventListener('click', () => {
            showNotification('info', 
                'Echo Voice Messenger Guide:\n\n' +
                '1. Record a voice message with the microphone button\n' +
                '2. Set privacy and expiry options\n' +
                '3. Upload and share the generated link\n' +
                '4. Manage your messages and requests in the tabs\n' +
                '5. All data is stored locally in your browser'
            );
        });

        // Tab Switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show corresponding content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });
            });
        });

        // Recording Functionality
        micBtn.addEventListener('click', startRecording);
        stopBtn.addEventListener('click', stopRecording);
        reRecordBtn.addEventListener('click', resetRecording);
        clearAllBtn.addEventListener('click', clearAllMessages);

        // Receiver functionality
        playBtn.addEventListener('click', () => {
            receiverAudio.play().catch(e => {
                showNotification('error', 'Could not play audio. Please try again.');
            });
        });

        downloadBtn.addEventListener('click', () => {
            if (receiverAudio.src) {
                const a = document.createElement('a');
                a.href = receiverAudio.src;
                a.download = 'voice-message.webm';
                a.click();
            }
        });

        requestIdentityBtn.addEventListener('click', () => {
            if (currentMessageId) {
                voiceManager.addRequest(currentMessageId, {
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent
                });
                showNotification('success', 'Identity request sent to the sender.');
                identityRequestSection.classList.add('hidden');
            }
        });

        backToHome.addEventListener('click', () => {
            // Remove voice parameter from URL and reload
            const url = new URL(window.location);
            url.searchParams.delete('voice');
            window.history.replaceState({}, '', url);
            showSenderView();
        });

        function startRecording() {
            if (isRecording) return;
            
            // Check if browser supports media recording
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification('error', 'Your browser does not support audio recording. Please try Chrome, Firefox, or Edge.');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    isRecording = true;
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        currentAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(currentAudioBlob);
                        preview.src = audioUrl;
                        
                        // Stop all tracks in the stream
                        stream.getTracks().forEach(track => track.stop());
                        
                        // Show preview section
                        audioPreviewSection.classList.remove('hidden');
                        uploadBtn.classList.remove('hidden');
                    };
                    
                    mediaRecorder.start();
                    recordingStartTime = Date.now();
                    
                    // Update UI
                    micBtn.classList.add('recording');
                    recordingIndicator.classList.remove('hidden');
                    stopBtn.disabled = false;
                    
                    // Start timer
                    startTimer();
                    
                    showNotification('success', 'Recording started. Speak now!');
                })
                .catch(err => {
                    console.error('Error accessing microphone:', err);
                    showNotification('error', 'Could not access microphone. Please check permissions and try again.');
                });
        }

        function stopRecording() {
            if (!isRecording) return;
            
            mediaRecorder.stop();
            isRecording = false;
            
            // Update UI
            micBtn.classList.remove('recording');
            recordingIndicator.classList.add('hidden');
            stopBtn.disabled = true;
            
            // Stop timer
            clearInterval(timerInterval);
            
            showNotification('success', 'Recording stopped. Preview your message below.');
        }

        function resetRecording() {
            audioPreviewSection.classList.add('hidden');
            uploadBtn.classList.add('hidden');
            preview.src = '';
            recordingTimer.textContent = '00:00';
            currentAudioBlob = null;
        }

        function startTimer() {
            recordingTimer.classList.remove('hidden');
            timerInterval = setInterval(() => {
                const elapsedTime = Date.now() - recordingStartTime;
                const seconds = Math.floor(elapsedTime / 1000);
                const minutes = Math.floor(seconds / 60);
                const displaySeconds = seconds % 60;
                recordingTimer.textContent = `${minutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Upload Button
        uploadBtn.addEventListener('click', () => {
            const senderName = document.getElementById('senderName').value || 'Anonymous';
            const privacy = document.getElementById('privacy').value;
            const expiry = document.getElementById('expiry').value;
            
            if (!currentAudioBlob) {
                showNotification('error', 'No recording found. Please record a message first.');
                return;
            }
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            
            // Convert blob to base64 for storage
            const reader = new FileReader();
            reader.onload = function() {
                const audioBlob = reader.result;
                
                // Create a unique URL for the audio
                const audioUrl = URL.createObjectURL(currentAudioBlob);
                
                // Add message to data manager
                const newMessage = voiceManager.addMessage({
                    title: `Voice Message ${voiceManager.getMessages().length + 1}`,
                    senderName: senderName,
                    privacy: privacy,
                    expiry: expiry,
                    audioUrl: audioUrl,
                    audioBlob: audioBlob
                });
                
                // Generate shareable link
                const shareUrl = `${window.location.origin}${window.location.pathname}?voice=${newMessage.id}`;
                
                showNotification('success', 
                    `Voice message uploaded successfully!\n\nShare this link:\n${shareUrl}`
                );
                
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload Voice';
                
                // Reset the recording UI
                resetRecording();
                
                // Clear form
                document.getElementById('senderName').value = '';
                
                // Update displays
                updateStatsDisplay();
                renderMessages();
                
                // Switch to messages tab to see the new message
                document.querySelector('.tab[data-tab="messages"]').click();
            };
            reader.readAsDataURL(currentAudioBlob);
        });

        // Render Messages
        function renderMessages() {
            const messages = voiceManager.getMessages();
            
            if (messages.length === 0) {
                emptyMessages.style.display = 'block';
                voiceMessagesGrid.innerHTML = '';
                voiceMessagesGrid.appendChild(emptyMessages);
                return;
            }
            
            emptyMessages.style.display = 'none';
            
            voiceMessagesGrid.innerHTML = messages.map(message => `
                <div class="voice-card card" data-message-id="${message.id}">
                    <div class="voice-card-header">
                        <div class="voice-card-title">${message.title}</div>
                        <div class="status-badge status-active">
                            <i class="fas fa-circle"></i>
                            ${message.status === 'active' ? 'Active' : 'Expired'}
                        </div>
                    </div>
                    <div class="voice-card-meta">
                        <div class="voice-card-meta-item">
                            <i class="fas fa-user"></i>
                            <span>${message.senderName}</span>
                        </div>
                        <div class="voice-card-meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>Created: ${new Date(message.timestamp).toLocaleDateString()}</span>
                        </div>
                        <div class="voice-card-meta-item">
                            <i class="fas fa-play-circle"></i>
                            <span>Plays: ${message.playCount || 0}</span>
                        </div>
                        <div class="voice-card-meta-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>Privacy: ${message.privacy}</span>
                        </div>
                    </div>
                    <div class="voice-card-actions">
                        <button class="btn btn-primary btn-sm play-btn">
                            <i class="fas fa-play"></i>
                            Play
                        </button>
                        <button class="btn btn-secondary btn-sm share-btn">
                            <i class="fas fa-share"></i>
                            Share
                        </button>
                        <button class="btn btn-danger btn-sm delete-btn">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Add event listeners to message cards
            document.querySelectorAll('.play-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const card = this.closest('.voice-card');
                    const messageId = card.getAttribute('data-message-id');
                    playMessage(messageId);
                });
            });
            
            document.querySelectorAll('.share-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const card = this.closest('.voice-card');
                    const messageId = card.getAttribute('data-message-id');
                    shareMessage(messageId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const card = this.closest('.voice-card');
                    const messageId = card.getAttribute('data-message-id');
                    deleteMessage(messageId);
                });
            });
        }

        // Render Requests
        function renderRequests() {
            const requests = voiceManager.getRequests();
            
            if (requests.length === 0) {
                emptyRequests.style.display = 'block';
                requestsGrid.innerHTML = '';
                requestsGrid.appendChild(emptyRequests);
                return;
            }
            
            emptyRequests.style.display = 'none';
            
            requestsGrid.innerHTML = requests.map(request => `
                <div class="voice-card card" data-request-id="${request.id}">
                    <div class="voice-card-header">
                        <div class="voice-card-title">${request.messageTitle}</div>
                        <div class="status-badge status-pending">
                            <i class="fas fa-clock"></i>
                            Pending
                        </div>
                    </div>
                    <div class="voice-card-meta">
                        <div class="voice-card-meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>Requested: ${new Date(request.timestamp).toLocaleDateString()}</span>
                        </div>
                        <div class="voice-card-meta-item">
                            <i class="fas fa-info-circle"></i>
                            <span>Someone wants to know your identity</span>
                        </div>
                    </div>
                    <div class="voice-card-actions">
                        <button class="btn btn-success btn-sm approve-btn">
                            <i class="fas fa-check"></i>
                            Approve
                        </button>
                        <button class="btn btn-danger btn-sm deny-btn">
                            <i class="fas fa-times"></i>
                            Deny
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Add event listeners to request cards
            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const card = this.closest('.voice-card');
                    const requestId = card.getAttribute('data-request-id');
                    resolveRequest(requestId, true);
                });
            });
            
            document.querySelectorAll('.deny-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const card = this.closest('.voice-card');
                    const requestId = card.getAttribute('data-request-id');
                    resolveRequest(requestId, false);
                });
            });
        }

        // Message Actions
        function playMessage(messageId) {
            const message = voiceManager.messages.find(msg => msg.id === messageId);
            if (message && message.audioUrl) {
                const audio = new Audio(message.audioUrl);
                audio.play().catch(e => {
                    showNotification('error', 'Could not play audio. Please try again.');
                });
                message.playCount = (message.playCount || 0) + 1;
                voiceManager.saveMessages();
                updateStatsDisplay();
            }
        }

        function shareMessage(messageId) {
            const message = voiceManager.messages.find(msg => msg.id === messageId);
            if (message) {
                const shareUrl = `${window.location.origin}${window.location.pathname}?voice=${message.id}`;
                
                // Try to use Web Share API if available
                if (navigator.share) {
                    navigator.share({
                        title: 'Voice Message',
                        text: 'Check out this voice message!',
                        url: shareUrl
                    });
                } else {
                    // Fallback to copying to clipboard
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        showNotification('success', 'Share link copied to clipboard!');
                    }).catch(() => {
                        // Final fallback - show the URL
                        showNotification('info', `Share this link: ${shareUrl}`);
                    });
                }
            }
        }

        function deleteMessage(messageId) {
            if (confirm('Are you sure you want to delete this voice message?')) {
                voiceManager.deleteMessage(messageId);
                updateStatsDisplay();
                renderMessages();
                showNotification('success', 'Voice message deleted successfully');
            }
        }

        function clearAllMessages() {
            if (voiceManager.getMessages().length === 0) {
                showNotification('info', 'No messages to clear');
                return;
            }
            
            if (confirm('Are you sure you want to delete ALL voice messages? This action cannot be undone.')) {
                voiceManager.clearAllMessages();
                updateStatsDisplay();
                renderMessages();
                showNotification('success', 'All voice messages have been cleared');
            }
        }

        // Request Actions
        function resolveRequest(requestId, approved) {
            voiceManager.resolveRequest(requestId, approved);
            updateStatsDisplay();
            renderRequests();
            showNotification('success', 
                `Identity request ${approved ? 'approved' : 'denied'} successfully`
            );
        }

        // Stats Management
        function updateStatsDisplay() {
            const stats = voiceManager.getStats();
            totalMessagesEl.textContent = stats.totalMessages;
            totalPlaysEl.textContent = stats.totalPlays;
            pendingRequestsEl.textContent = stats.pendingRequests;
            successRateEl.textContent = stats.successRate + '%';
        }

        // Notification System
        function showNotification(type, message) {
            // Set notification type
            notification.className = 'notification';
            notification.classList.add(`notification-${type}`);
            
            // Set icon based on type
            let iconClass;
            switch(type) {
                case 'success':
                    iconClass = 'fas fa-check-circle';
                    break;
                case 'error':
                    iconClass = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    iconClass = 'fas fa-exclamation-triangle';
                    break;
                case 'info':
                default:
                    iconClass = 'fas fa-info-circle';
                    break;
            }
            
            notificationIcon.className = `notification-icon ${iconClass}`;
            notificationContent.textContent = message;
            
            // Show notification
            notification.classList.add('show');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Close notification when clicked
        notification.addEventListener('click', () => {
            notification.classList.remove('show');
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', checkUrlParams);
    </script>
</body>
</html>
