<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EchoChat ‚Äì Voice to Live Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* -------------------------
   MODERN THEME COLORS + VARIABLES
   ------------------------- */
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  --dark-bg: #0f0f1a;
  --darker-bg: #0a0a12;
  --card-dark: rgba(255,255,255,0.05);
  --text-primary: #ffffff;
  --text-secondary: rgba(255,255,255,0.7);
  --text-light: rgba(255,255,255,0.5);
  --border-dark: rgba(255,255,255,0.1);
  --shadow-soft: 0 8px 32px rgba(0,0,0,0.2);
  --radius-small: 12px;
  --radius-medium: 16px;
}

/* -------------------------
   BASE STYLES
   ------------------------- */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', sans-serif;
  background: var(--dark-bg);
  color: var(--text-primary);
  min-height: 100vh;
}

/* -------------------------
   LAYOUT COMPONENTS
   ------------------------- */
.app-container {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.main-header {
  background: rgba(15, 15, 26, 0.9);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border-dark);
  padding: 1rem 2rem;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo {
  font-size: 1.5rem;
  font-weight: 700;
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.main-content {
  flex: 1;
  padding: 6rem 1rem 2rem;
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
}

/* -------------------------
   VIEW MANAGEMENT
   ------------------------- */
.view {
  display: none;
}

.view.active {
  display: block;
}

/* -------------------------
   SENDER VIEW STYLES
   ------------------------- */
.voice-card {
  background: var(--card-dark);
  border: 1px solid var(--border-dark);
  border-radius: var(--radius-medium);
  padding: 2rem;
  margin-bottom: 2rem;
  backdrop-filter: blur(20px);
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.form-select, .form-input {
  width: 100%;
  padding: 1rem;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border-dark);
  border-radius: var(--radius-small);
  color: var(--text-primary);
  font-family: inherit;
}

.recording-section {
  text-align: center;
  margin: 2rem 0;
}

.mic-button {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: var(--card-dark);
  border: 2px solid var(--border-dark);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 1rem;
  cursor: pointer;
  font-size: 2rem;
  transition: all 0.3s ease;
}

.mic-button.recording {
  background: var(--secondary-gradient);
  transform: scale(1.1);
}

.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: var(--radius-small);
  font-family: inherit;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-primary {
  background: var(--accent-gradient);
  color: white;
}

.btn-secondary {
  background: rgba(255,255,255,0.1);
  color: var(--text-primary);
}

/* -------------------------
   CHAT VIEW STYLES
   ------------------------- */
.chat-container {
  background: var(--card-dark);
  border: 1px solid var(--border-dark);
  border-radius: var(--radius-medium);
  height: 70vh;
  display: flex;
  flex-direction: column;
  backdrop-filter: blur(20px);
}

.chat-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--border-dark);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-messages {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.message {
  max-width: 70%;
  padding: 0.75rem 1rem;
  border-radius: var(--radius-small);
  position: relative;
}

.message.sent {
  background: var(--accent-gradient);
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.message.received {
  background: rgba(255,255,255,0.1);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}

.message-status {
  font-size: 0.7rem;
  opacity: 0.7;
  margin-top: 0.25rem;
  text-align: right;
}

.chat-input-container {
  padding: 1rem;
  border-top: 1px solid var(--border-dark);
  display: flex;
  gap: 0.5rem;
}

.chat-input {
  flex: 1;
  padding: 0.75rem;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border-dark);
  border-radius: var(--radius-small);
  color: var(--text-primary);
  font-family: inherit;
}

/* -------------------------
   CHAT REQUEST STYLES
   ------------------------- */
.chat-request {
  text-align: center;
  padding: 2rem;
}

.request-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-top: 1.5rem;
}

/* -------------------------
   STATUS INDICATORS
   ------------------------- */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
}

.status-active {
  background: rgba(67, 233, 123, 0.2);
  color: #43e97b;
}

.status-pending {
  background: rgba(255, 193, 7, 0.2);
  color: #ffc107;
}

/* -------------------------
   RESPONSIVE DESIGN
   ------------------------- */
@media (max-width: 768px) {
  .main-header {
    padding: 1rem;
  }
  
  .main-content {
    padding: 5rem 1rem 1rem;
  }
  
  .voice-card {
    padding: 1.5rem;
    margin: 0 -0.5rem 1.5rem;
  }
  
  .message {
    max-width: 85%;
  }
}

.hidden {
  display: none !important;
}

.fade-in {
  animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="main-header">
      <div class="header-content">
        <div class="logo">EchoChat</div>
        <div class="header-actions">
          <button class="btn btn-secondary" id="themeBtn">üåó Theme</button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      
      <!-- Sender View -->
      <div id="senderView" class="view active">
        <div class="voice-card fade-in">
          <h2>Send Voice Message</h2>
          <p>Start with a voice message, then chat live</p>
          
          <div class="form-group">
            <label class="form-label">Your Name</label>
            <input type="text" class="form-input" id="senderName" placeholder="Enter your name">
          </div>

          <div class="recording-section">
            <div class="mic-button" id="micBtn">üéôÔ∏è</div>
            <audio id="preview" controls hidden></audio>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
              <button class="btn btn-secondary" id="stopBtn" disabled>Stop</button>
              <button class="btn btn-primary" id="uploadBtn" hidden>Upload & Share</button>
            </div>
          </div>

          <div id="result"></div>
        </div>
      </div>

      <!-- Receiver View -->
      <div id="receiverView" class="view">
        <div class="voice-card fade-in">
          <div id="voiceMessageSection">
            <h2>Voice Message Received</h2>
            <audio id="playAudio" controls></audio>
            <div id="receiverStatus"></div>
            
            <!-- Chat Request Section -->
            <div id="chatRequestSection" class="chat-request">
              <h3>üí¨ Start a Conversation?</h3>
              <p>The sender wants to chat with you live</p>
              <div class="request-actions">
                <button class="btn btn-secondary" id="declineChat">Decline</button>
                <button class="btn btn-primary" id="acceptChat">Accept Chat</button>
              </div>
            </div>
          </div>

          <!-- Chat Interface -->
          <div id="chatInterface" class="hidden">
            <div class="chat-container">
              <div class="chat-header">
                <div>
                  <strong>Live Chat</strong>
                  <div id="chatPartnerName"></div>
                </div>
                <div class="status-indicator status-active">
                  <div class="online-dot"></div>
                  Online
                </div>
              </div>
              
              <div class="chat-messages" id="chatMessages">
                <!-- Messages will appear here -->
              </div>
              
              <div class="chat-input-container">
                <input type="text" class="chat-input" id="messageInput" placeholder="Type your message...">
                <button class="btn btn-primary" id="sendMessage">Send</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat View (After acceptance) -->
      <div id="chatView" class="view">
        <div class="voice-card fade-in">
          <div class="chat-container">
            <div class="chat-header">
              <div>
                <strong>Live Chat</strong>
                <div id="chatWithUser"></div>
              </div>
              <div class="status-indicator status-active">
                <div class="online-dot"></div>
                Online
              </div>
            </div>
            
            <div class="chat-messages" id="mainChatMessages">
              <!-- Messages will appear here -->
            </div>
            
            <div class="chat-input-container">
              <input type="text" class="chat-input" id="mainMessageInput" placeholder="Type your message...">
              <button class="btn btn-primary" id="mainSendMessage">Send</button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Loader -->
  <div id="loader" class="loader hidden">
    <div>Loading...</div>
  </div>

<script>
// -------------------------
// APP STATE MANAGEMENT
// -------------------------
const AppState = {
  currentUser: null,
  currentChat: null,
  messages: [],
  isRecording: false,
  mediaRecorder: null,
  audioChunks: []
};

// -------------------------
// DOM ELEMENTS
// -------------------------
const views = {
  sender: document.getElementById('senderView'),
  receiver: document.getElementById('receiverView'),
  chat: document.getElementById('chatView')
};

const elements = {
  // Sender elements
  micBtn: document.getElementById('micBtn'),
  stopBtn: document.getElementById('stopBtn'),
  preview: document.getElementById('preview'),
  uploadBtn: document.getElementById('uploadBtn'),
  senderName: document.getElementById('senderName'),
  result: document.getElementById('result'),
  
  // Receiver elements
  playAudio: document.getElementById('playAudio'),
  receiverStatus: document.getElementById('receiverStatus'),
  chatRequestSection: document.getElementById('chatRequestSection'),
  chatInterface: document.getElementById('chatInterface'),
  acceptChat: document.getElementById('acceptChat'),
  declineChat: document.getElementById('declineChat'),
  
  // Chat elements
  chatMessages: document.getElementById('chatMessages'),
  mainChatMessages: document.getElementById('mainChatMessages'),
  messageInput: document.getElementById('messageInput'),
  mainMessageInput: document.getElementById('mainMessageInput'),
  sendMessage: document.getElementById('sendMessage'),
  mainSendMessage: document.getElementById('mainSendMessage'),
  chatPartnerName: document.getElementById('chatPartnerName'),
  chatWithUser: document.getElementById('chatWithUser')
};

// -------------------------
// VIEW MANAGEMENT
// -------------------------
function showView(viewName) {
  // Hide all views
  Object.values(views).forEach(view => view.classList.remove('active'));
  // Show requested view
  views[viewName].classList.add('active');
}

// -------------------------
// VOICE RECORDING
// -------------------------
elements.micBtn.addEventListener('click', startRecording);
elements.stopBtn.addEventListener('click', stopRecording);

async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    AppState.mediaRecorder = new MediaRecorder(stream);
    AppState.audioChunks = [];
    
    AppState.mediaRecorder.ondataavailable = (e) => {
      AppState.audioChunks.push(e.data);
    };
    
    AppState.mediaRecorder.onstop = () => {
      const audioBlob = new Blob(AppState.audioChunks, { type: 'audio/webm' });
      elements.preview.src = URL.createObjectURL(audioBlob);
      elements.preview.hidden = false;
      elements.uploadBtn.hidden = false;
    };
    
    AppState.mediaRecorder.start();
    AppState.isRecording = true;
    elements.micBtn.classList.add('recording');
    elements.stopBtn.disabled = false;
    
  } catch (error) {
    alert('Microphone access required for recording');
  }
}

function stopRecording() {
  if (AppState.mediaRecorder && AppState.isRecording) {
    AppState.mediaRecorder.stop();
    AppState.isRecording = false;
    elements.micBtn.classList.remove('recording');
    elements.stopBtn.disabled = true;
  }
}

// -------------------------
// VOICE MESSAGE UPLOAD & SHARING
// -------------------------
elements.uploadBtn.addEventListener('click', uploadVoiceMessage);

async function uploadVoiceMessage() {
  const senderName = elements.senderName.value || 'Anonymous';
  
  elements.uploadBtn.disabled = true;
  elements.uploadBtn.textContent = 'Uploading...';
  
  try {
    // Simulate upload process
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    const voiceData = {
      id: 'voice_' + Math.random().toString(36).slice(2, 11),
      senderName: senderName,
      timestamp: new Date().toISOString(),
      hasChatRequest: true // Always include chat request for demo
    };
    
    // Save to localStorage
    localStorage.setItem('currentVoiceMessage', JSON.stringify(voiceData));
    
    // Generate share link
    const shareLink = `${window.location.origin}?voice=${voiceData.id}&sender=${encodeURIComponent(senderName)}`;
    
    // Show success message with chat info
    elements.result.innerHTML = `
      <div style="margin-top: 1rem; padding: 1rem; background: rgba(67, 233, 123, 0.1); border-radius: 8px;">
        <h4>‚úÖ Voice Message Sent!</h4>
        <p><strong>Share this link:</strong></p>
        <input value="${shareLink}" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px; border: 1px solid #ccc;" readonly>
        <p style="margin-top: 0.5rem; font-size: 0.9rem;">
          <strong>üí¨ Chat Feature:</strong> When receiver opens this link, they can start a live chat with you!
        </p>
        <button class="btn btn-primary" onclick="copyToClipboard('${shareLink}')" style="margin-top: 0.5rem;">
          Copy Link
        </button>
      </div>
    `;
    
  } catch (error) {
    elements.result.innerHTML = `
      <div style="color: #ff6b6b; margin-top: 1rem;">
        Upload failed. Please try again.
      </div>
    `;
  } finally {
    elements.uploadBtn.disabled = false;
    elements.uploadBtn.textContent = 'Upload & Share';
  }
}

// -------------------------
// CHAT FUNCTIONALITY
// -------------------------
elements.acceptChat.addEventListener('click', acceptChatRequest);
elements.declineChat.addEventListener('click', declineChatRequest);
elements.sendMessage.addEventListener('click', sendMessage);
elements.mainSendMessage.addEventListener('click', sendMainMessage);

// Enter key support for message input
elements.messageInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendMessage();
});

elements.mainMessageInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendMainMessage();
});

function acceptChatRequest() {
  // Hide voice message section, show chat interface
  document.getElementById('voiceMessageSection').classList.add('hidden');
  elements.chatInterface.classList.remove('hidden');
  
  // Set up the chat
  const urlParams = new URLSearchParams(window.location.search);
  const senderName = urlParams.get('sender') || 'Anonymous';
  elements.chatPartnerName.textContent = `Chatting with ${senderName}`;
  
  // Add welcome message
  addMessage('system', `You are now chatting with ${senderName}. Start the conversation!`, 'chatMessages');
}

function declineChatRequest() {
  elements.receiverStatus.innerHTML = `
    <div style="color: #ff6b6b; margin-top: 1rem;">
      Chat request declined. You can still listen to the voice message.
    </div>
  `;
  elements.chatRequestSection.classList.add('hidden');
}

function sendMessage() {
  const message = elements.messageInput.value.trim();
  if (!message) return;
  
  addMessage('sent', message, 'chatMessages');
  elements.messageInput.value = '';
  
  // Simulate reply after 1-3 seconds
  setTimeout(() => {
    const replies = [
      "Thanks for the voice message! How are you?",
      "That was interesting! Tell me more.",
      "I'd love to continue this conversation!",
      "Great to connect with you!",
      "What else would you like to talk about?"
    ];
    const randomReply = replies[Math.floor(Math.random() * replies.length)];
    addMessage('received', randomReply, 'chatMessages');
  }, 1000 + Math.random() * 2000);
}

function sendMainMessage() {
  const message = elements.mainMessageInput.value.trim();
  if (!message) return;
  
  addMessage('sent', message, 'mainChatMessages');
  elements.mainMessageInput.value = '';
  
  // Simulate reply
  setTimeout(() => {
    const replies = [
      "I'm doing great! How about you?",
      "That's awesome!",
      "Tell me more about that!",
      "I completely agree!",
      "What are your thoughts on this?"
    ];
    const randomReply = replies[Math.floor(Math.random() * replies.length)];
    addMessage('received', randomReply, 'mainChatMessages');
  }, 1000 + Math.random() * 2000);
}

function addMessage(type, content, containerId) {
  const container = document.getElementById(containerId);
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${type}`;
  
  const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  
  messageDiv.innerHTML = `
    <div>${content}</div>
    <div class="message-status">
      ${timestamp} 
      ${type === 'sent' ? '‚úì‚úì' : ''}
    </div>
  `;
  
  container.appendChild(messageDiv);
  container.scrollTop = container.scrollHeight;
}

// -------------------------
// MESSAGE STATUS (Single/Double Tick)
// -------------------------
function updateMessageStatus(messageId, status) {
  // status: 'sent', 'delivered', 'read'
  const statusElement = document.querySelector(`[data-message-id="${messageId}"] .message-status`);
  if (statusElement) {
    let statusIcon = '‚úì'; // Single tick for sent
    if (status === 'delivered') statusIcon = '‚úì‚úì'; // Double tick for delivered
    if (status === 'read') statusIcon = '‚úì‚úìüîµ'; // Blue ticks for read
    
    statusElement.innerHTML = `${statusIcon} ‚Ä¢ ${new Date().toLocaleTimeString()}`;
  }
}

// -------------------------
// UTILITY FUNCTIONS
// -------------------------
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('Link copied to clipboard!');
  });
}

// -------------------------
// URL PARAMETER HANDLING
// -------------------------
function handleUrlParameters() {
  const urlParams = new URLSearchParams(window.location.search);
  const voiceId = urlParams.get('voice');
  const senderName = urlParams.get('sender');
  
  if (voiceId) {
    // This is a receiver viewing a voice message
    showView('receiver');
    
    // Show sender name in chat request
    if (senderName) {
      document.querySelector('#chatRequestSection p').textContent = 
        `${senderName} wants to start a live chat with you after sending this voice message.`;
    }
    
    // Simulate voice message playback
    elements.playAudio.src = "https://www.soundjay.com/button/beep-07.wav"; // Demo audio
    
  } else {
    // This is a sender creating a new message
    showView('sender');
  }
}

// -------------------------
// INITIALIZATION
// -------------------------
document.addEventListener('DOMContentLoaded', () => {
  // Initialize user
  if (!localStorage.getItem('echo_user_id')) {
    localStorage.setItem('echo_user_id', 'user_' + Math.random().toString(36).slice(2, 9));
  }
  AppState.currentUser = localStorage.getItem('echo_user_id');
  
  // Handle URL parameters to determine view
  handleUrlParameters();
  
  // Theme toggle
  document.getElementById('themeBtn').addEventListener('click', () => {
    document.body.style.filter = document.body.style.filter === 'invert(1)' ? 'none' : 'invert(1)';
  });
});

// -------------------------
// DEMO DATA FOR TESTING
// -------------------------
// Add some demo messages when page loads for testing
setTimeout(() => {
  if (document.getElementById('mainChatMessages').children.length === 0) {
    addMessage('received', "Hey there! Thanks for the voice message. I'd love to chat more!", 'mainChatMessages');
    addMessage('sent', "Hi! Glad you liked the voice message. How's your day going?", 'mainChatMessages');
    addMessage('received', "It's going great! The voice message was really clear. What made you decide to send it?", 'mainChatMessages');
  }
}, 1000);
</script>
</body>
</html>
