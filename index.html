<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Echo ‚Äì Anonymous Voice Connect</title>
<style>
/* (your full CSS unchanged) */
:root{
  --black-bg:#0b0b0b;
  --white-bg:#fdfdfd;
  --glass-dark:rgba(255,255,255,0.07);
  --glass-light:rgba(0,0,0,0.07);
  --border-light:rgba(255,255,255,0.1);
  --border-dark:rgba(0,0,0,0.1);
  --accent:#00d1ff;
  --font-main:"Poppins",sans-serif;
}
*{box-sizing:border-box;transition:all .20s ease}
html,body{height:100%}
body{
  font-family:var(--font-main);
  background:linear-gradient(135deg,var(--black-bg),#202020);
  color:#fff;margin:0;padding:0;min-height:100vh;
  display:flex;flex-direction:column;align-items:center;padding:20px;
}
body.light{background:linear-gradient(135deg,var(--white-bg),#d9d9d9);color:#111}
.header-buttons{position:fixed;top:12px;right:12px;display:flex;gap:10px;z-index:1200;}
button.header-btn{border:none;border-radius:999px;background:rgba(255,255,255,0.08);color:inherit;padding:10px 14px;cursor:pointer}
.app{width:100%;max-width:980px;background:var(--glass-dark);border-radius:16px;padding:24px;margin-top:84px;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-top:18px}
.card{background:rgba(255,255,255,0.06);border-radius:10px;padding:12px;}
.card a{color:var(--accent);word-break:break-all;text-decoration:none}
</style>
</head>
<body>
  <div class="header-buttons">
    <button id="guideBtn" class="header-btn">‚ùî Guide</button>
    <button id="themeBtn" class="header-btn">üåó Theme</button>
  </div>

  <div class="app" id="app" hidden>
    <h2>Echo ‚Äì Anonymous Voice Connect</h2>
    <p class="sub">Record ‚Üí Upload ‚Üí Share. Dashboard updates live when someone interacts.</p>

    <div id="senderView">
      <label for="privacy">Privacy</label>
      <select id="privacy">
        <option value="anonymous">Anonymous</option>
        <option value="reveal_on_request">Reveal on Request</option>
        <option value="auto_reveal">Auto Reveal</option>
      </select>

      <label for="expiry">Expiry</label>
      <select id="expiry">
        <option value="permanent">Permanent</option>
        <option value="24h">24 hours</option>
      </select>

      <label for="senderName">Your Name</label>
      <input id="senderName" placeholder="e.g. Sandy" />

      <div class="mic" id="micBtn">üéôÔ∏è</div>
      <button id="stopBtn" disabled>‚èπ Stop</button>
      <audio id="preview" controls hidden></audio>
      <button id="uploadBtn" hidden>‚¨ÜÔ∏è Upload</button>

      <div id="result" style="margin-top:12px"></div>

      <h3 style="margin-top:22px">My Voices</h3>
      <div id="grid" class="grid"></div>
    </div>

    <div id="receiverView" hidden>
      <h3>Incoming Voice Message üîä</h3>
      <audio id="playAudio" controls></audio>
      <button id="playBtn">‚ñ∂Ô∏è Play</button>
      <div id="receiverStatus" style="margin-top:10px"></div>
      <div id="revealSection" style="margin-top:12px"></div>
    </div>
  </div>

  <div id="loader" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;color:#fff;">Loading Echo...</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const BASE_URL = window.location.origin;
const socket = io(BASE_URL, { transports: ['websocket','polling'] });
const params = new URLSearchParams(window.location.search);
const voiceId = params.get("v");
const loader = document.getElementById("loader");
const app = document.getElementById("app");
const senderView = document.getElementById("senderView");
const receiverView = document.getElementById("receiverView");
const themeBtn = document.getElementById("themeBtn");
const guideBtn = document.getElementById("guideBtn");

let dark = true;
themeBtn.onclick = () => {
  dark = !dark;
  document.body.classList.toggle('light', !dark);
  themeBtn.textContent = dark ? "üåó Theme" : "‚òÄÔ∏è Theme";
};

guideBtn.onclick = () => alert("1Ô∏è‚É£ Record voice\n2Ô∏è‚É£ Upload\n3Ô∏è‚É£ Share unique link");

if (!localStorage.getItem('echo_id')) localStorage.setItem('echo_id','echo_'+Math.random().toString(36).slice(2,9));
const SENDER_ID = localStorage.getItem('echo_id');

socket.on('connect',()=>socket.emit('register_sender',SENDER_ID));

window.addEventListener('load',()=>{
  loader.style.display='none';
  app.hidden=false;
  if(location.pathname.startsWith("/v/")){senderView.hidden=true;receiverView.hidden=false;loadReceiver(location.pathname.split("/v/")[1]);}
  else{senderView.hidden=false;receiverView.hidden=true;loadDashboard();}
});

let mediaRecorder,chunks=[];
const micBtn=document.getElementById('micBtn');
const stopBtn=document.getElementById('stopBtn');
const preview=document.getElementById('preview');
const uploadBtn=document.getElementById('uploadBtn');
const result=document.getElementById('result');

micBtn.onclick=async()=>{
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  mediaRecorder=new MediaRecorder(stream);
  chunks=[];
  mediaRecorder.ondataavailable=e=>chunks.push(e.data);
  mediaRecorder.onstop=()=>{
    const blob=new Blob(chunks,{type:'audio/webm'});
    preview.src=URL.createObjectURL(blob);
    preview.hidden=false;uploadBtn.hidden=false;
  };
  mediaRecorder.start();micBtn.classList.add('recording');stopBtn.disabled=false;
};

stopBtn.onclick=()=>{if(mediaRecorder&&mediaRecorder.state==='recording')mediaRecorder.stop();micBtn.classList.remove('recording');stopBtn.disabled=true;};

uploadBtn.onclick=async()=>{
  const blob=new Blob(chunks,{type:'audio/webm'});
  const form=new FormData();
  form.append('voice',blob);
  form.append('privacy',document.getElementById('privacy').value);
  form.append('expiry',document.getElementById('expiry').value);
  form.append('senderId',SENDER_ID);
  form.append('senderName',document.getElementById('senderName').value||'Anonymous');
  uploadBtn.disabled=true;uploadBtn.textContent='Uploading...';
  const res=await fetch(`${BASE_URL}/api/upload`,{method:'POST',body:form});
  const data=await res.json();
  if(data.ok){
    result.innerHTML=`‚úÖ Uploaded!<br>Share this link:<br>
      <input value="${data.link}" readonly style="width:100%;padding:8px;border-radius:8px"/>
      <button onclick="navigator.clipboard.writeText('${data.link}')">Copy</button>`;
    loadDashboard();
  }else result.textContent='Upload failed.';
  uploadBtn.disabled=false;uploadBtn.textContent='‚¨ÜÔ∏è Upload';
};

async function loadDashboard(){
  const grid=document.getElementById('grid');
  grid.innerHTML='Loading...';
  const res=await fetch(`${BASE_URL}/api/dashboard/${SENDER_ID}`);
  const rows=await res.json();
  grid.innerHTML=rows.length?rows.map(v=>`
    <div class="card">
      <b>${v.senderName||'Anonymous'}</b>
      <a href="${BASE_URL}/v/${v.id}" target="_blank">${v.id}</a>
      <small>Privacy: ${v.privacy} | Expiry: ${v.expiry}</small>
      <div>Opened: ${v.openCount||0} | Played: ${v.playCount||0}</div>
      ${v.revealRequest&&!v.revealApproved?`<button onclick="approveReveal('${v.id}')">Approve Reveal</button>`:v.revealApproved?`<p>üëÅÔ∏è Reveal Approved</p>`:''}
    </div>`).join(''):'<p>No voices yet.</p>';
}

async function approveReveal(id){
  await fetch(`${BASE_URL}/api/approve-reveal/${id}`,{method:'POST'});
  loadDashboard();
}

async function loadReceiver(id){
  const res=await fetch(`${BASE_URL}/api/voice/${id}`);
  if(!res.ok)return document.getElementById('receiverStatus').textContent='Not found';
  const data=await res.json();
  const playAudio=document.getElementById('playAudio');
  playAudio.src=`${BASE_URL}/play/${data.path}`;
  await fetch(`${BASE_URL}/api/open/${id}`,{method:'POST'});
  const revealSection=document.getElementById('revealSection');
  if(data.privacy==='auto_reveal')revealSection.innerHTML=`üë§ Sender: <b>${data.senderName}</b>`;
  else if(data.privacy==='reveal_on_request')revealSection.innerHTML=`<button id='reqBtn'>Request Reveal</button>`;
  document.getElementById('reqBtn')?.addEventListener('click',async()=>{await fetch(`${BASE_URL}/api/request-reveal/${id}`,{method:'POST'});revealSection.innerHTML='‚è≥ Request sent...';});
  document.getElementById('playBtn').onclick=async()=>{playAudio.play();await fetch(`${BASE_URL}/api/play/${id}`,{method:'POST'});};
}

socket.on('reveal_request',d=>{if(d.senderId===SENDER_ID)alert('üîî Reveal requested!');loadDashboard();});
socket.on('reveal_approved',()=>{loadDashboard();if(location.pathname.startsWith("/v/"))loadReceiver(location.pathname.split("/v/")[1]);});
</script>
</body>
</html>
