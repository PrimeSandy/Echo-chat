<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EchoChat ‚Äì Voice to Live Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* -------------------------
   MODERN THEME COLORS + VARIABLES
   ------------------------- */
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  --dark-bg: #0f0f1a;
  --darker-bg: #0a0a12;
  --card-dark: rgba(255,255,255,0.05);
  --text-primary: #ffffff;
  --text-secondary: rgba(255,255,255,0.7);
  --text-light: rgba(255,255,255,0.5);
  --border-dark: rgba(255,255,255,0.1);
  --shadow-soft: 0 8px 32px rgba(0,0,0,0.2);
  --radius-small: 12px;
  --radius-medium: 16px;
}

/* -------------------------
   BASE STYLES
   ------------------------- */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', sans-serif;
  background: var(--dark-bg);
  color: var(--text-primary);
  min-height: 100vh;
}

/* -------------------------
   LAYOUT COMPONENTS
   ------------------------- */
.app-container {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.main-header {
  background: rgba(15, 15, 26, 0.9);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border-dark);
  padding: 1rem 2rem;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo {
  font-size: 1.5rem;
  font-weight: 700;
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.main-content {
  flex: 1;
  padding: 6rem 1rem 2rem;
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
}

/* -------------------------
   VIEW MANAGEMENT
   ------------------------- */
.view {
  display: none;
}

.view.active {
  display: block;
}

/* -------------------------
   SENDER VIEW STYLES
   ------------------------- */
.voice-card {
  background: var(--card-dark);
  border: 1px solid var(--border-dark);
  border-radius: var(--radius-medium);
  padding: 2rem;
  margin-bottom: 2rem;
  backdrop-filter: blur(20px);
}

.card-title {
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.card-subtitle {
  color: var(--text-secondary);
  margin-bottom: 1.5rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.form-select, .form-input {
  width: 100%;
  padding: 1rem;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border-dark);
  border-radius: var(--radius-small);
  color: var(--text-primary);
  font-family: inherit;
}

.select-wrapper {
  position: relative;
}

.select-wrapper::after {
  content: '‚ñº';
  position: absolute;
  right: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-light);
  pointer-events: none;
  font-size: 0.7rem;
}

.recording-section {
  text-align: center;
  margin: 2rem 0;
}

.mic-button {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: var(--card-dark);
  border: 2px solid var(--border-dark);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 1rem;
  cursor: pointer;
  font-size: 2rem;
  transition: all 0.3s ease;
}

.mic-button.recording {
  background: var(--secondary-gradient);
  transform: scale(1.1);
  box-shadow: 0 0 20px rgba(245, 87, 108, 0.4);
}

.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: var(--radius-small);
  font-family: inherit;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-primary {
  background: var(--accent-gradient);
  color: white;
}

.btn-secondary {
  background: rgba(255,255,255,0.1);
  color: var(--text-primary);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.action-buttons {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-top: 1rem;
}

/* -------------------------
   CHAT VIEW STYLES
   ------------------------- */
.chat-container {
  background: var(--card-dark);
  border: 1px solid var(--border-dark);
  border-radius: var(--radius-medium);
  height: 70vh;
  display: flex;
  flex-direction: column;
  backdrop-filter: blur(20px);
}

.chat-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--border-dark);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-messages {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.message {
  max-width: 70%;
  padding: 0.75rem 1rem;
  border-radius: var(--radius-small);
  position: relative;
}

.message.sent {
  background: var(--accent-gradient);
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.message.received {
  background: rgba(255,255,255,0.1);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}

.message-status {
  font-size: 0.7rem;
  opacity: 0.7;
  margin-top: 0.25rem;
  text-align: right;
}

.chat-input-container {
  padding: 1rem;
  border-top: 1px solid var(--border-dark);
  display: flex;
  gap: 0.5rem;
}

.chat-input {
  flex: 1;
  padding: 0.75rem;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border-dark);
  border-radius: var(--radius-small);
  color: var(--text-primary);
  font-family: inherit;
}

/* -------------------------
   CHAT REQUEST STYLES
   ------------------------- */
.chat-request {
  text-align: center;
  padding: 2rem;
  background: rgba(255,255,255,0.03);
  border-radius: var(--radius-small);
  margin: 1.5rem 0;
  border: 1px solid var(--border-dark);
}

.request-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-top: 1.5rem;
}

/* -------------------------
   STATUS INDICATORS
   ------------------------- */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
}

.status-active {
  background: rgba(67, 233, 123, 0.2);
  color: #43e97b;
  border: 1px solid rgba(67, 233, 123, 0.3);
}

.status-pending {
  background: rgba(255, 193, 7, 0.2);
  color: #ffc107;
  border: 1px solid rgba(255, 193, 7, 0.3);
}

.status-expired {
  background: rgba(245, 87, 108, 0.2);
  color: #f5576c;
  border: 1px solid rgba(245, 87, 108, 0.3);
}

/* -------------------------
   IDENTITY REVEAL SECTION
   ------------------------- */
.identity-section {
  background: rgba(255,255,255,0.03);
  border-radius: var(--radius-small);
  padding: 1.5rem;
  margin: 1.5rem 0;
  border: 1px solid var(--border-dark);
  text-align: center;
}

/* -------------------------
   RESPONSIVE DESIGN
   ------------------------- */
@media (max-width: 768px) {
  .main-header {
    padding: 1rem;
  }
  
  .main-content {
    padding: 5rem 1rem 1rem;
  }
  
  .voice-card {
    padding: 1.5rem;
    margin: 0 -0.5rem 1.5rem;
  }
  
  .message {
    max-width: 85%;
  }
  
  .request-actions {
    flex-direction: column;
  }
}

.hidden {
  display: none !important;
}

.fade-in {
  animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.online-dot {
  width: 8px;
  height: 8px;
  background: #43e97b;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
</style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="main-header">
      <div class="header-content">
        <div class="logo">EchoChat</div>
        <div class="header-actions">
          <button class="btn btn-secondary" id="themeBtn">üåó Theme</button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      
      <!-- Sender View -->
      <div id="senderView" class="view active">
        <div class="voice-card fade-in">
          <h2 class="card-title">Send Voice Message</h2>
          <p class="card-subtitle">Start with a voice message, then chat live</p>
          
          <div class="form-group">
            <label class="form-label">Privacy Setting</label>
            <div class="select-wrapper">
              <select class="form-select" id="privacy">
                <option value="anonymous">Anonymous - No identity revealed</option>
                <option value="reveal_on_request">Reveal on Request - Approve identity requests</option>
                <option value="auto_reveal">Auto Reveal - Show identity automatically</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Message Expiry</label>
            <div class="select-wrapper">
              <select class="form-select" id="expiry">
                <option value="permanent">Permanent - Never expires</option>
                <option value="24h">24 Hours - Auto-deletes after 1 day</option>
                <option value="1h">1 Hour - Quick temporary message</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Your Display Name</label>
            <input type="text" class="form-input" id="senderName" placeholder="Enter your name or stay anonymous">
          </div>

          <!-- Recording Section -->
          <div class="recording-section">
            <div class="mic-button" id="micBtn">
              <span class="mic-icon">üéôÔ∏è</span>
            </div>
            <audio id="preview" controls hidden></audio>
            
            <div class="action-buttons">
              <button class="btn btn-secondary" id="stopBtn" disabled>‚èπÔ∏è Stop</button>
              <button class="btn btn-primary" id="uploadBtn" hidden>üöÄ Upload & Share</button>
            </div>
          </div>

          <!-- Result Section -->
          <div id="result"></div>

          <!-- Sender Chat Requests Section -->
          <div id="senderChatRequests" class="hidden">
            <h3 class="card-title">Chat Requests</h3>
            <div id="chatRequestsList">
              <!-- Chat requests will appear here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Receiver View -->
      <div id="receiverView" class="view">
        <div class="voice-card fade-in">
          <div id="voiceMessageSection">
            <h2 class="card-title">Voice Message Received</h2>
            <div class="status-indicator status-active">
              <span>üîä</span>
              <span id="expiryStatus">This message is permanent</span>
            </div>
            
            <audio id="playAudio" controls style="width: 100%; margin: 1rem 0;"></audio>
            <div id="receiverStatus"></div>
            
            <!-- Identity Reveal Section -->
            <div id="identitySection" class="identity-section">
              <h4>üë§ Sender Identity</h4>
              <div id="identityContent">
                <!-- Identity content will be loaded here -->
              </div>
              <button class="btn btn-primary" id="requestIdentity" style="margin-top: 1rem;">
                üîç Request Sender Identity
              </button>
            </div>
            
            <!-- Chat Request Section -->
            <div id="chatRequestSection" class="chat-request">
              <h3>üí¨ Start a Live Chat?</h3>
              <p>Connect with the sender for real-time conversation</p>
              <div class="request-actions">
                <button class="btn btn-secondary" id="declineChat">No Thanks</button>
                <button class="btn btn-primary" id="acceptChat">‚úÖ Accept Chat</button>
              </div>
            </div>
          </div>

          <!-- Chat Interface -->
          <div id="chatInterface" class="hidden">
            <div class="chat-container">
              <div class="chat-header">
                <div>
                  <strong>Live Chat</strong>
                  <div id="chatPartnerName">Chatting with Sender</div>
                </div>
                <div class="status-indicator status-active">
                  <div class="online-dot"></div>
                  Online
                </div>
              </div>
              
              <div class="chat-messages" id="chatMessages">
                <!-- Messages will appear here -->
              </div>
              
              <div class="chat-input-container">
                <input type="text" class="chat-input" id="messageInput" placeholder="Type your message...">
                <button class="btn btn-primary" id="sendMessage">Send</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Chat View -->
      <div id="chatView" class="view">
        <div class="voice-card fade-in">
          <div class="chat-container">
            <div class="chat-header">
              <div>
                <strong>Live Chat</strong>
                <div id="chatWithUser">Active Conversation</div>
              </div>
              <div class="status-indicator status-active">
                <div class="online-dot"></div>
                Online
              </div>
            </div>
            
            <div class="chat-messages" id="mainChatMessages">
              <!-- Messages will appear here -->
            </div>
            
            <div class="chat-input-container">
              <input type="text" class="chat-input" id="mainMessageInput" placeholder="Type your message...">
              <button class="btn btn-primary" id="mainSendMessage">Send</button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

<script>
// -------------------------
// APP STATE MANAGEMENT
// -------------------------
const AppState = {
  currentUser: null,
  currentVoiceMessage: null,
  activeChat: null,
  chatRequests: [],
  isRecording: false,
  mediaRecorder: null,
  audioChunks: []
};

// -------------------------
// DOM ELEMENTS
// -------------------------
const elements = {
  // Sender elements
  micBtn: document.getElementById('micBtn'),
  stopBtn: document.getElementById('stopBtn'),
  preview: document.getElementById('preview'),
  uploadBtn: document.getElementById('uploadBtn'),
  senderName: document.getElementById('senderName'),
  privacy: document.getElementById('privacy'),
  expiry: document.getElementById('expiry'),
  result: document.getElementById('result'),
  senderChatRequests: document.getElementById('senderChatRequests'),
  chatRequestsList: document.getElementById('chatRequestsList'),
  
  // Receiver elements
  playAudio: document.getElementById('playAudio'),
  receiverStatus: document.getElementById('receiverStatus'),
  expiryStatus: document.getElementById('expiryStatus'),
  identitySection: document.getElementById('identitySection'),
  identityContent: document.getElementById('identityContent'),
  requestIdentity: document.getElementById('requestIdentity'),
  chatRequestSection: document.getElementById('chatRequestSection'),
  chatInterface: document.getElementById('chatInterface'),
  acceptChat: document.getElementById('acceptChat'),
  declineChat: document.getElementById('declineChat'),
  
  // Chat elements
  chatMessages: document.getElementById('chatMessages'),
  mainChatMessages: document.getElementById('mainChatMessages'),
  messageInput: document.getElementById('messageInput'),
  mainMessageInput: document.getElementById('mainMessageInput'),
  sendMessage: document.getElementById('sendMessage'),
  mainSendMessage: document.getElementById('mainSendMessage'),
  chatPartnerName: document.getElementById('chatPartnerName'),
  chatWithUser: document.getElementById('chatWithUser'),
  
  // Views
  senderView: document.getElementById('senderView'),
  receiverView: document.getElementById('receiverView'),
  chatView: document.getElementById('chatView')
};

// -------------------------
// VIEW MANAGEMENT
// -------------------------
function showView(viewName) {
  // Hide all views
  document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
  // Show requested view
  document.getElementById(viewName + 'View').classList.add('active');
}

// -------------------------
// VOICE RECORDING
// -------------------------
elements.micBtn.addEventListener('click', startRecording);
elements.stopBtn.addEventListener('click', stopRecording);

async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    AppState.mediaRecorder = new MediaRecorder(stream);
    AppState.audioChunks = [];
    
    AppState.mediaRecorder.ondataavailable = (e) => {
      AppState.audioChunks.push(e.data);
    };
    
    AppState.mediaRecorder.onstop = () => {
      const audioBlob = new Blob(AppState.audioChunks, { type: 'audio/webm' });
      elements.preview.src = URL.createObjectURL(audioBlob);
      elements.preview.hidden = false;
      elements.uploadBtn.hidden = false;
    };
    
    AppState.mediaRecorder.start();
    AppState.isRecording = true;
    elements.micBtn.classList.add('recording');
    elements.stopBtn.disabled = false;
    
  } catch (error) {
    alert('Microphone access required for recording');
  }
}

function stopRecording() {
  if (AppState.mediaRecorder && AppState.isRecording) {
    AppState.mediaRecorder.stop();
    AppState.isRecording = false;
    elements.micBtn.classList.remove('recording');
    elements.stopBtn.disabled = true;
  }
}

// -------------------------
// VOICE MESSAGE UPLOAD & SHARING
// -------------------------
elements.uploadBtn.addEventListener('click', uploadVoiceMessage);

async function uploadVoiceMessage() {
  const senderName = elements.senderName.value || 'Anonymous';
  const privacy = elements.privacy.value;
  const expiry = elements.expiry.value;
  
  elements.uploadBtn.disabled = true;
  elements.uploadBtn.innerHTML = '‚è≥ Uploading...';
  
  try {
    // Simulate upload process
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    const voiceData = {
      id: 'voice_' + Math.random().toString(36).slice(2, 11),
      senderName: senderName,
      privacy: privacy,
      expiry: expiry,
      timestamp: new Date().toISOString(),
      senderId: AppState.currentUser,
      hasChatRequest: true
    };
    
    // Save to localStorage
    localStorage.setItem('currentVoiceMessage', JSON.stringify(voiceData));
    saveVoiceMessage(voiceData);
    
    // Generate share link
    const shareLink = `${window.location.origin}?voice=${voiceData.id}`;
    
    // Show success message
    elements.result.innerHTML = `
      <div class="fade-in" style="margin-top: 1.5rem; padding: 1.5rem; background: rgba(67, 233, 123, 0.1); border-radius: var(--radius-small); border: 1px solid rgba(67, 233, 123, 0.3);">
        <div class="status-indicator status-active" style="margin-bottom: 1rem;">
          <span>‚úÖ</span>
          Voice Message Sent Successfully!
        </div>
        <p><strong>Share this link:</strong></p>
        <input value="${shareLink}" style="width: 100%; padding: 0.75rem; margin: 0.5rem 0; border-radius: var(--radius-small); background: rgba(255,255,255,0.05); border: 1px solid var(--border-dark); color: var(--text-primary);" readonly>
        <div class="share-actions" style="display: flex; gap: 0.5rem; margin-top: 1rem;">
          <button class="btn btn-secondary" onclick="copyToClipboard('${shareLink}')">
            üìã Copy Link
          </button>
          <button class="btn btn-primary" onclick="generateQRCode('${shareLink}')">
            üì± QR Code
          </button>
        </div>
        <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: var(--radius-small);">
          <p style="margin: 0; font-size: 0.9rem;">
            <strong>Settings:</strong><br>
            Privacy: ${getPrivacyText(privacy)} | Expiry: ${getExpiryText(expiry)}<br>
            <strong>üí¨ Chat Feature:</strong> Receiver can start live chat after listening
          </p>
        </div>
      </div>
    `;
    
    // Show chat requests section for sender
    elements.senderChatRequests.classList.remove('hidden');
    loadChatRequests();
    
  } catch (error) {
    elements.result.innerHTML = `
      <div class="status-indicator status-expired" style="margin-top: 1rem;">
        <span>‚ùå</span>
        Upload failed. Please try again.
      </div>
    `;
  } finally {
    elements.uploadBtn.disabled = false;
    elements.uploadBtn.innerHTML = 'üöÄ Upload & Share';
  }
}

// -------------------------
// CHAT REQUEST SYSTEM
// -------------------------
elements.acceptChat.addEventListener('click', acceptChatRequest);
elements.declineChat.addEventListener('click', declineChatRequest);
elements.requestIdentity.addEventListener('click', requestSenderIdentity);

function acceptChatRequest() {
  const urlParams = new URLSearchParams(window.location.search);
  const voiceId = urlParams.get('voice');
  const voiceData = getVoiceMessage(voiceId);
  
  if (voiceData) {
    // Create chat request
    const chatRequest = {
      id: 'chat_' + Math.random().toString(36).slice(2, 11),
      voiceId: voiceId,
      receiverId: AppState.currentUser,
      senderId: voiceData.senderId,
      timestamp: new Date().toISOString(),
      status: 'accepted'
    };
    
    // Save chat request
    saveChatRequest(chatRequest);
    
    // Notify sender (in real app, this would be via WebSocket)
    showNotification('Chat request accepted! Starting conversation...');
    
    // Start chat session
    startChatSession(voiceData.senderName, 'receiver');
  }
}

function declineChatRequest() {
  elements.chatRequestSection.innerHTML = `
    <div class="status-indicator status-expired">
      <span>‚ùå</span>
      Chat request declined
    </div>
  `;
}

function requestSenderIdentity() {
  const urlParams = new URLSearchParams(window.location.search);
  const voiceId = urlParams.get('voice');
  const voiceData = getVoiceMessage(voiceId);
  
  if (voiceData) {
    if (voiceData.privacy === 'auto_reveal') {
      // Show identity immediately
      elements.identityContent.innerHTML = `
        <div class="status-indicator status-active">
          <span>üë§</span>
          Sender: <strong>${voiceData.senderName}</strong>
        </div>
      `;
      elements.requestIdentity.classList.add('hidden');
    } else if (voiceData.privacy === 'reveal_on_request') {
      // Create identity request
      const identityRequest = {
        id: 'identity_' + Math.random().toString(36).slice(2, 11),
        voiceId: voiceId,
        receiverId: AppState.currentUser,
        senderId: voiceData.senderId,
        timestamp: new Date().toISOString(),
        status: 'pending'
      };
      
      saveIdentityRequest(identityRequest);
      
      elements.identityContent.innerHTML = `
        <div class="status-indicator status-pending">
          <span>‚è≥</span>
          Identity request sent. Waiting for sender approval...
        </div>
      `;
      elements.requestIdentity.classList.add('hidden');
      
      // Notify sender
      showNotification('Someone requested your identity!');
    } else {
      elements.identityContent.innerHTML = `
        <div class="status-indicator status-expired">
          <span>üîí</span>
          Sender prefers to remain anonymous
        </div>
      `;
      elements.requestIdentity.classList.add('hidden');
    }
  }
}

// -------------------------
// CHAT FUNCTIONALITY
// -------------------------
elements.sendMessage.addEventListener('click', sendMessage);
elements.mainSendMessage.addEventListener('click', sendMainMessage);

// Enter key support
elements.messageInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendMessage();
});

elements.mainMessageInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendMainMessage();
});

function sendMessage() {
  const message = elements.messageInput.value.trim();
  if (!message) return;
  
  addMessage('sent', message, 'chatMessages');
  elements.messageInput.value = '';
  
  // Simulate typing and reply
  simulateTyping('chatMessages', () => {
    const randomReply = getRandomReply();
    addMessage('received', randomReply, 'chatMessages');
  });
}

function sendMainMessage() {
  const message = elements.mainMessageInput.value.trim();
  if (!message) return;
  
  addMessage('sent', message, 'mainChatMessages');
  elements.mainMessageInput.value = '';
  
  // Simulate typing and reply
  simulateTyping('mainChatMessages', () => {
    const randomReply = getRandomReply();
    addMessage('received', randomReply, 'mainChatMessages');
  });
}

function addMessage(type, content, containerId) {
  const container = document.getElementById(containerId);
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${type} fade-in`;
  
  const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  
  messageDiv.innerHTML = `
    <div>${content}</div>
    <div class="message-status">
      ${timestamp} 
      ${type === 'sent' ? '<span class="message-ticks">‚úì‚úì</span>' : ''}
    </div>
  `;
  
  container.appendChild(messageDiv);
  container.scrollTop = container.scrollHeight;
}

function simulateTyping(containerId, callback) {
  const container = document.getElementById(containerId);
  const typingDiv = document.createElement('div');
  typingDiv.className = 'message received';
  typingDiv.innerHTML = `
    <div style="opacity: 0.7;">
      <span class="typing-dots">
        <span>.</span><span>.</span><span>.</span>
      </span>
    </div>
  `;
  
  container.appendChild(typingDiv);
  container.scrollTop = container.scrollHeight;
  
  setTimeout(() => {
    container.removeChild(typingDiv);
    callback();
  }, 1000 + Math.random() * 1000);
}

function getRandomReply() {
  const replies = [
    "That's interesting! Tell me more.",
    "I see what you mean!",
    "Thanks for sharing that with me!",
    "What do you think about this?",
    "That's a great point!",
    "I'd love to hear more about that!",
    "How was your day otherwise?",
    "That sounds exciting!",
    "I completely understand!",
    "What are your plans for this?"
  ];
  return replies[Math.floor(Math.random() * replies.length)];
}

function startChatSession(partnerName, userType) {
  if (userType === 'receiver') {
    // Receiver starts chat in their view
    elements.voiceMessageSection.classList.add('hidden');
    elements.chatInterface.classList.remove('hidden');
    elements.chatPartnerName.textContent = `Chatting with ${partnerName}`;
    
    // Add welcome message
    addMessage('system', `You are now chatting with ${partnerName}. Start the conversation!`, 'chatMessages');
  } else {
    // Sender starts chat in main chat view
    showView('chat');
    elements.chatWithUser.textContent = `Chatting with ${partnerName}`;
    
    // Add welcome message
    addMessage('system', `You are now chatting with ${partnerName}. Start the conversation!`, 'mainChatMessages');
  }
}

// -------------------------
// DATA MANAGEMENT
// -------------------------
function saveVoiceMessage(voiceData) {
  let voices = JSON.parse(localStorage.getItem('echo_voices') || '[]');
  voices.push(voiceData);
  localStorage.setItem('echo_voices', JSON.stringify(voices));
}

function getVoiceMessage(voiceId) {
  const voices = JSON.parse(localStorage.getItem('echo_voices') || '[]');
  return voices.find(v => v.id === voiceId);
}

function saveChatRequest(chatRequest) {
  let requests = JSON.parse(localStorage.getItem('echo_chat_requests') || '[]');
  requests.push(chatRequest);
  localStorage.setItem('echo_chat_requests', JSON.stringify(requests));
}

function saveIdentityRequest(identityRequest) {
  let requests = JSON.parse(localStorage.getItem('echo_identity_requests') || '[]');
  requests.push(identityRequest);
  localStorage.setItem('echo_identity_requests', JSON.stringify(requests));
}

function loadChatRequests() {
  const requests = JSON.parse(localStorage.getItem('echo_chat_requests') || '[]');
  const userRequests = requests.filter(req => req.senderId === AppState.currentUser && req.status === 'accepted');
  
  if (userRequests.length > 0) {
    elements.chatRequestsList.innerHTML = userRequests.map(req => `
      <div class="status-indicator status-active" style="margin: 0.5rem 0; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: var(--radius-small);">
        <span>üí¨</span>
        New chat request accepted!
        <button class="btn btn-primary" onclick="startChatSession('Receiver', 'sender')" style="margin-left: 1rem; padding: 0.5rem 1rem;">
          Start Chat
        </button>
      </div>
    `).join('');
  }
}

// -------------------------
// UTILITY FUNCTIONS
// -------------------------
function getPrivacyText(privacy) {
  const privacyMap = {
    'anonymous': 'Anonymous',
    'reveal_on_request': 'Reveal on Request',
    'auto_reveal': 'Auto Reveal'
  };
  return privacyMap[privacy] || privacy;
}

function getExpiryText(expiry) {
  const expiryMap = {
    'permanent': 'Permanent',
    '1h': '1 Hour',
    '24h': '24 Hours'
  };
  return expiryMap[expiry] || expiry;
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    showNotification('Link copied to clipboard!');
  });
}

function generateQRCode(link) {
  alert(`QR Code for: ${link}\n\nIn a real app, this would generate a QR code.`);
}

function showNotification(message) {
  // Create a simple notification
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 100px;
    right: 20px;
    background: var(--accent-gradient);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: var(--radius-small);
    z-index: 10000;
    animation: slideIn 0.3s ease-out;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    document.body.removeChild(notification);
  }, 3000);
}

// -------------------------
// URL PARAMETER HANDLING
// -------------------------
function handleUrlParameters() {
  const urlParams = new URLSearchParams(window.location.search);
  const voiceId = urlParams.get('voice');
  
  if (voiceId) {
    // This is a receiver viewing a voice message
    showView('receiver');
    
    const voiceData = getVoiceMessage(voiceId);
    if (voiceData) {
      // Set up receiver view based on voice data
      elements.expiryStatus.textContent = `Expires: ${getExpiryText(voiceData.expiry)}`;
      
      // Handle identity section based on privacy setting
      if (voiceData.privacy === 'auto_reveal') {
        elements.identityContent.innerHTML = `
          <div class="status-indicator status-active">
            <span>üë§</span>
            Sender: <strong>${voiceData.senderName}</strong>
          </div>
        `;
        elements.requestIdentity.classList.add('hidden');
      }
      
      // Show chat request section
      elements.chatRequestSection.classList.remove('hidden');
    }
  } else {
    // This is a sender creating a new message
    showView('sender');
  }
}

// -------------------------
// INITIALIZATION
// -------------------------
document.addEventListener('DOMContentLoaded', () => {
  // Initialize user
  if (!localStorage.getItem('echo_user_id')) {
    localStorage.setItem('echo_user_id', 'user_' + Math.random().toString(36).slice(2, 9));
  }
  AppState.currentUser = localStorage.getItem('echo_user_id');
  
  // Handle URL parameters to determine view
  handleUrlParameters();
  
  // Theme toggle
  document.getElementById('themeBtn').addEventListener('click', () => {
    document.body.style.filter = document.body.style.filter === 'invert(1)' ? 'none' : 'invert(1)';
  });
  
  // Load initial data
  loadChatRequests();
});

// Add some demo messages for testing
setTimeout(() => {
  if (document.getElementById('mainChatMessages').children.length === 0) {
    addMessage('received', "Hey there! Thanks for connecting. How can I help you today?", 'mainChatMessages');
  }
}, 1000);
</script>
</body>
</html>
