<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Echo ‚Äì Anonymous Voice Connect</title>
<style>
/* (--- your same CSS as before, unchanged ---) */
:root{
  --black-bg:#0b0b0b;
  --white-bg:#fdfdfd;
  --glass-dark:rgba(255,255,255,0.07);
  --glass-light:rgba(0,0,0,0.07);
  --border-light:rgba(255,255,255,0.1);
  --border-dark:rgba(0,0,0,0.1);
  --accent:#00d1ff;
  --font-main:"Poppins",sans-serif;
}
*{box-sizing:border-box;transition:all .20s ease}
html,body{height:100%}
body{
  font-family:var(--font-main);
  background:linear-gradient(135deg,var(--black-bg),#202020);
  color:#fff;margin:0;padding:0;min-height:100vh;
  display:flex;flex-direction:column;align-items:center;padding:20px;
}
body.light{background:linear-gradient(135deg,var(--white-bg),#d9d9d9);color:#111;}
.header-buttons{position:fixed;top:12px;right:12px;display:flex;gap:10px;z-index:1200;}
button.header-btn{border:none;border-radius:999px;background:rgba(255,255,255,0.08);
color:inherit;padding:10px 14px;cursor:pointer;backdrop-filter:blur(6px);}
button.header-btn:hover{background:rgba(255,255,255,0.16)}
.app{width:100%;max-width:980px;background:var(--glass-dark);
backdrop-filter:blur(10px);border-radius:16px;padding:24px;margin-top:84px;
box-shadow:0 10px 40px rgba(0,0,0,0.45);}
.mic{width:110px;height:110px;border-radius:999px;margin:18px auto;
display:flex;align-items:center;justify-content:center;font-size:34px;cursor:pointer;
background:rgba(255,255,255,0.08);}
.mic.recording{background:linear-gradient(135deg,#ff4b8a,#ff3b6b);}
button{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;margin:6px 0;
background:rgba(255,255,255,0.12);color:inherit;font-weight:600}
audio{width:100%;margin-top:8px;border-radius:10px;background:transparent}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-top:18px}
.card{background:rgba(255,255,255,0.06);border-radius:10px;padding:12px;}
</style>
</head>
<body>
  <div class="header-buttons">
    <button id="guideBtn" class="header-btn">‚ùî Guide</button>
    <button id="themeBtn" class="header-btn">üåó Theme</button>
  </div>

  <div class="app" id="app" hidden>
    <h2>Echo ‚Äì Anonymous Voice Connect</h2>
    <p class="sub">Record ‚Üí Upload ‚Üí Share. Dashboard updates live when someone interacts.</p>

    <!-- Sender -->
    <div id="senderView">
      <label>Privacy</label>
      <select id="privacy">
        <option value="anonymous">Anonymous</option>
        <option value="reveal_on_request">Reveal on Request</option>
        <option value="auto_reveal">Auto Reveal</option>
      </select>

      <label>Expiry</label>
      <select id="expiry">
        <option value="permanent">Permanent</option>
        <option value="24h">24 hours</option>
      </select>

      <label>Your Name</label>
      <input id="senderName" placeholder="e.g. Sandy" />

      <div class="mic" id="micBtn">üéôÔ∏è</div>
      <button id="stopBtn" disabled>‚èπ Stop</button>
      <audio id="preview" controls hidden></audio>
      <button id="uploadBtn" hidden>‚¨ÜÔ∏è Upload</button>

      <div id="result" style="margin-top:12px"></div>

      <h3 style="margin-top:22px">My Voices</h3>
      <div id="grid" class="grid"></div>
    </div>

    <!-- Receiver -->
    <div id="receiverView" hidden>
      <h3>Incoming Voice Message üîä</h3>
      <audio id="playAudio" controls></audio>
      <button id="playBtn">‚ñ∂Ô∏è Play</button>
      <div id="receiverStatus" style="margin-top:10px;color:rgba(255,255,255,0.7)"></div>
      <div id="revealSection" style="margin-top:12px"></div>
    </div>
  </div>

  <div id="loader" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;color:#fff;z-index:1400">Loading Echo...</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const BASE_URL = window.location.origin;
const socket = io(BASE_URL);
const params = new URLSearchParams(window.location.search);
const voiceId = params.get("v");
const loader = document.getElementById("loader");
const app = document.getElementById("app");
const senderView = document.getElementById("senderView");
const receiverView = document.getElementById("receiverView");
const themeBtn = document.getElementById("themeBtn");
const guideBtn = document.getElementById("guideBtn");

/* THEME */
let dark = true;
themeBtn.onclick = () => {
  dark = !dark;
  document.body.classList.toggle('light', !dark);
  themeBtn.textContent = dark ? "üåó Theme" : "‚òÄÔ∏è Theme";
};

/* GUIDE */
guideBtn.onclick = () => {
  alert("How Echo works:\n\n1) Record a short voice note.\n2) Upload to get a link + QR.\n3) Share either the link or QR.");
};

/* sender ID */
if (!localStorage.getItem('echo_id')) {
  localStorage.setItem('echo_id', 'echo_' + Math.random().toString(36).slice(2,9));
}
const SENDER_ID = localStorage.getItem('echo_id');

socket.on('connect', () => socket.emit('register_sender', SENDER_ID));

window.addEventListener('load', () => {
  loader.style.display = 'none';
  app.hidden = false;
  if (voiceId) {
    senderView.hidden = true;
    receiverView.hidden = false;
    loadReceiver();
  } else {
    senderView.hidden = false;
    receiverView.hidden = true;
    loadDashboard();
  }
});

/* Recording */
let mediaRecorder, chunks = [];
const micBtn = document.getElementById('micBtn');
const stopBtn = document.getElementById('stopBtn');
const preview = document.getElementById('preview');
const uploadBtn = document.getElementById('uploadBtn');
const result = document.getElementById('result');

micBtn.onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    chunks = [];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      preview.src = URL.createObjectURL(blob);
      preview.hidden = false;
      uploadBtn.hidden = false;
    };
    mediaRecorder.start();
    micBtn.classList.add('recording');
    stopBtn.disabled = false;
  } catch {
    alert('Please allow microphone access.');
  }
};

stopBtn.onclick = () => {
  if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
  micBtn.classList.remove('recording');
  stopBtn.disabled = true;
};

/* Upload + Dashboard + QR */
uploadBtn.onclick = async () => {
  const blob = new Blob(chunks, { type: 'audio/webm' });
  const form = new FormData();
  form.append('voice', blob);
  form.append('privacy', document.getElementById('privacy').value);
  form.append('expiry', document.getElementById('expiry').value);
  form.append('senderId', SENDER_ID);
  form.append('senderName', document.getElementById('senderName').value || 'Anonymous');

  uploadBtn.disabled = true; uploadBtn.textContent = 'Uploading...';
  try {
    const res = await fetch(`${BASE_URL}/api/upload`, { method: 'POST', body: form });
    const data = await res.json();
    if (data.ok) {
      const qrURL = `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encodeURIComponent(data.link)}`;
      result.innerHTML = `
        <p style="color:var(--accent)">‚úÖ Uploaded! Share this link or scan the QR:</p>
        <input value="${data.link}" style="width:100%;padding:8px;border-radius:8px" readonly />
        <button style="margin-top:8px" onclick="navigator.clipboard.writeText('${data.link}')">Copy Link</button>
        <div style="margin-top:12px;text-align:center">
          <img src="${qrURL}" alt="QR Code" width="160" height="160" style="border-radius:10px"/>
          <p style="opacity:0.8;font-size:14px">Scan to open voice</p>
        </div>`;
      await loadDashboard();
    } else result.textContent = 'Upload failed.';
  } catch {
    result.textContent = 'Upload failed.';
  } finally {
    uploadBtn.disabled = false; uploadBtn.textContent = '‚¨ÜÔ∏è Upload';
  }
};

/* Dashboard + Reveal unchanged */
async function loadDashboard(){ /* same logic as before */ }

/* Receiver unchanged */
async function loadReceiver(){ /* same logic as before */ }

/* Socket realtime unchanged */
socket.on('reveal_request', d=>{
  if(d.senderId===SENDER_ID){alert('üîî Reveal request received');loadDashboard();}
});
if(voiceId){
  socket.on(`reveal_approved_${voiceId}`, d=>{
    document.getElementById("revealSection").innerHTML=`<p>üë§ Sender: <b>${d.senderName}</b></p>`;
  });
}
</script>
</body>
</html>
